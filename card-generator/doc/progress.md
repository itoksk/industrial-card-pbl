# 危険物カード生成ツール - 開発進捗

## 2026-02-06: 統一プロンプトシステム再設計

### 完了した作業

#### 1. `src/lib/hazmat-data.ts` - プロンプトシステムの統一

- **新型定義の追加**
  - `CardType`: `"dangerous" | "extinguish" | "transport" | "regulation"`
  - `CardTypeConfig`: 各種別の共通ビジュアル設定(バッジ色・フレーム色・背景グラデーション・装飾スタイル)
  - `DangerousGoodsCardData`: 物質名・分類・各数値・ゲーム効果・イラストヒント
  - `ExtinguishCardData`: 消火器具名・種別(第1種~第5種)・第4類使用可否・効果・事実根拠
  - `TransportCardData`: カード名・強化効果・事実根拠
  - `RegulationCardData`: カード名・妨害効果・法的根拠
  - `AnyCardData`: 4型のユニオン型

- **統一プロンプトビルダー `buildBasePrompt()`**
  - 全カード共通のTCGカード構造テンプレート
  - フレーム/イラスト/情報欄/効果テキスト/背景装飾の統一レイアウト

- **4種別のプロンプト生成関数**
  | 関数 | カード種別 | バッジ色 | フレーム色 |
  |---|---|---|---|
  | `generateDangerousGoodsPrompt()` | 危険物(攻撃) | 分類ごと | 分類ごと |
  | `generateExtinguishCardPrompt()` | 消火(防御) | 青 | 青メタリック |
  | `generateTransportCardPrompt()` | 運搬(強化) | 緑 | 緑メタリック |
  | `generateRegulationCardPrompt()` | 法令(妨害) | 金色 | 金色メタリック |
  | `generateCardPrompt()` | 全種別ディスパッチャ | - | - |

- **サンプルデータの更新** (調査シート.xlsxから抜粋)
  - `sampleDangerousGoods`: 8件 (ジエチルエーテル, 二硫化炭素, ガソリン, アセトン, エタノール, 灯油, 重油, アマニ油)
  - `sampleExtinguishData`: 5件 (消火栓, スプリンクラー, 不活性ガス, CO2消火器, 乾燥砂)
  - `sampleTransportData`: 5件 (密閉, 遮光被覆, 過積載, 制限外許可証, 危標識)
  - `sampleRegulationData`: 5件 (使用停止令, 改修命令, 立入検査, 混載制限, 定期点検)

- **テンプレートの更新**
  - 消火テンプレート: 新統一フォーマット(4件)
  - 運搬テンプレート: 新規作成(4件)
  - 法令テンプレート: 新統一フォーマット(4件)
  - `allTemplates`に`transport`を追加

- **後方互換**
  - 旧関数(`generatePromptFromData`, `generateExtinguishPrompt`, `generateRegulationPrompt`)はラッパーとして維持
  - 旧インターフェース(`SubstanceData`, `ExtinguishData`, `RegulationData`)は維持

#### 2. `src/app/page.tsx` - UI更新

- **運搬タブの追加**: トラックアイコン + カード名・効果内容・事実根拠の3フィールドフォーム
- **消火タブの刷新**: 物質ベース → 消火器具ベースの入力に変更。種別セレクタ + 第4類使用可否トグル
- **法令タブの簡素化**: 4サブタイプを廃止、シンプルにカード名・妨害効果・法的根拠の3フィールド
- **タブ構成**: テンプレート | 危険物 | 消火 | 運搬 | 法令 | 直接入力 (6タブ)
- **categoryConfig**に`transport`キー追加

#### 3. `src/app/globals.css` - スタイル追加

- `.sample-button-blue`: 消火カード用(青テーマ)
- `.sample-button-teal`: 運搬カード用(ティールテーマ)
- `.sample-button-amber`: 法令カード用(アンバーテーマ)
- 各ボタンにライトモード対応あり

### カラーシステム

| カード種別 | 主要色 | 役割 |
|---|---|---|
| 危険物 | 分類準拠(赤/橙/紫/黄/緑/青緑/茶) | 攻撃 |
| 消火 | 青 (#3B82F6) | 防御 |
| 運搬 | 緑 (#22C55E) | 強化 |
| 法令 | 金 (#EAB308) | 妨害 |

### ビルド結果
- `npm run build`: 成功（エラー0、警告0）

---

## 2026-02-06: チュートリアル・ヘルプ機能 + カード裏面デザイン

### 完了した作業

#### 4. Driver.js チュートリアルシステム (`src/app/page.tsx`)

- **Driver.js v1.x の導入** (`npm install driver.js`)
- **7ステップのインタラクティブツアー**
  1. ヘッダー: ツール概要
  2. APIキー入力: 設定方法の説明
  3. タブナビゲーション: 6つのカード作成方法の紹介
  4. 入力パネル: サンプルデータの使い方
  5. 出力パネル: 生成結果の確認方法
  6. カード裏面ボタン: 裏面デザイン機能の説明
  7. ヘルプボタン: ツアー再表示方法

- **自動開始**: 初回訪問時に800ms後にツアーが自動スタート
- **ヘルプボタン**: ヘッダーに`?`アイコンのボタンを追加。いつでもツアーを再表示可能
- **LocalStorage永続化**: `hazmat-tour-completed`フラグで初回判定

#### 5. カード裏面デザイン機能 (`src/app/page.tsx`)

- **裏面画像アップロード**: モーダルUIで画像ファイル(PNG/JPG/WebP)をアップロード
- **LocalStorage保存**: `hazmat-card-back`キーでData URLを永続化
- **表裏切り替え**: カード生成後、出力パネルに「裏面を表示」ボタンが表示
- **画像管理**: アップロード済み画像のプレビュー、変更、削除が可能
- **ヘッダーインジケーター**: 裏面画像が設定済みの場合、ボタンに緑色のドットを表示

#### 6. `src/app/globals.css` - Driver.jsスタイルカスタマイズ

- `.hazmat-tour-popover`: ダーク/ライトモード対応のカスタムポップオーバー
- ガラスモーフィズム風のバックドロップブラー
- アクセントカラー(オレンジ)の「次へ」ボタン
- プログレスインジケーターのスタイリング

### ビルド結果
- `npm run build`: 成功（エラー0、警告0）

#### 7. カード裏面デフォルトデザインの組み込み

- **デフォルト画像**: `resource/hazmat_card_back_design.png` を `public/card-back.png` に配置
- **初期状態で設定済み**: アプリ起動時からデフォルトの裏面デザインが利用可能
- **カスタム上書き**: ユーザーが独自の裏面画像をアップロードして差し替え可能
- **デフォルト復帰**: カスタム画像を削除すると元のデフォルトデザインに戻る
- **モーダルUI**: 「デフォルトデザイン」/「カスタム画像」のラベル表示で現在の状態が一目でわかる

### ビルド結果
- `npm run build`: 成功（エラー0、警告0）

### 今後の課題
- 調査シート.xlsxからの一括読み込み・一括プロンプト生成機能
- 生成画像の一括ダウンロード
- カードデータのJSONエクスポート/インポート

---

## 2026-02-06: WCAG AA寄りの視認性調整 + 厳密レイアウト統一

### 完了した作業

#### 8. 視認性改善（WCAG AA目標）

- 低コントラストのテキスト/ラベル/タブ/フィルタ/バッジを全体的に引き上げ
- ライト/ダークそれぞれでの可読性を優先して色調整
- エラー表示やステータスバッジのコントラストを強化

#### 9. 厳密なカードレイアウト統一（イラスト分離）

- **生成方式を変更**
  - 旧: AIがカード全体を描画（レイアウトぶれが発生）
  - 新: **AIは中央イラストのみ生成**し、**カード枠/タイトル/情報欄/効果欄はアプリ側で固定描画**
- **固定テンプレート描画**
  - 2:3比率のカードをCanvasで合成
  - 情報欄は3行固定（不足は `—`）
  - 効果欄は固定位置・固定サイズ・2行以内
- **種別ごとの色とパレットを固定**
  - 危険物は分類ごとにバッジ/フレーム/背景グラデーションを固定
  - 消火/運搬/法令は専用パレットで統一

#### 変更ファイル

- `src/app/globals.css`
- `src/app/page.tsx`
- `src/lib/hazmat-data.ts`

---

## 2026-02-06: CSV一括発行 + 学習補完フロー実装

### 完了した作業

#### 10. CSV一括発行タブの追加 (`src/app/page.tsx`)

- タブ構成を **7タブ** に拡張（`一括発行`を追加）
- 種別ごとのテンプレートCSVダウンロード機能
- CSVアップロード機能
- 読み込み後の確認UI
  - 原文効果
  - 整頓後効果
  - 学習補足（国家試験向け要点）
- 「確認済み」チェック後にのみ一括発行
- 一括発行結果の一覧表示、個別保存、全件ダウンロード

#### 11. CSVパース/下書き生成ユーティリティ追加 (`src/lib/bulk-csv.ts`)

- 改行を含むセル対応のCSVパーサー実装
- 列名ゆらぎ対応（消化/消火、全角半角、括弧表記差）
- 4種別（危険物/消火/運搬/法令）の自動判定
- 各行をカード下書きへ変換し、描画モデル・イラストプロンプトを生成

#### 12. 学習補完ロジックの共通化 (`src/lib/hazmat-data.ts`)

- 効果文整頓 `polishGameEffectText()`
  - 改行・表記ゆれを整形
  - 実生活に寄りすぎる危険表現を学習用途向けに調整
  - 長文をカード用に要約
- 事実補足
  - 物質名/分類ベースの学習要点を自動補完
  - 消火/運搬/法令の典型要点を補完
- 個別生成・一括生成で同じ補完ロジックを利用

### ビルド結果
- `npm run build`: 成功（エラー0、警告0）
